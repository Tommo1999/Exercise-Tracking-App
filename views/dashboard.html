<!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Rep Dog Workout Tracker</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: black;
  color: white;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 30px 20px;
}

.header {
  text-align: center;
  margin-bottom: 40px;
}

.header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.dashboard-section {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: grey;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  flex: 1 1 calc(50% - 20px); /* Initially takes 50% minus margin */
  min-width: 300px;  /* Ensures a minimum width */
  margin-bottom: 20px;
  
  /* Centering content */
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;

  /* Ensuring card is responsive */
  width: 100%; /* Allow the card to shrink */
  box-sizing: border-box; /* Ensure padding does not affect width */
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
  .card {
    padding: 15px; /* Slightly reduce padding */
    flex: 1 1 calc(100% - 40px); /* Let card take 100% width on medium screens */
  }
}

@media (max-width: 375px) {
  .card {
    padding: 10px; /* Existing padding */
    margin: 0 15px 20px 15px; /* Add horizontal margin on phones */
  }
}
.card h2 {
  font-size: 1.5rem;
  margin-bottom: 10px;
}

/* Base Button Style */
.btn {
  background-color: #e74c3c; /* Original red */
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.3s;
}

/* Hover Effect - Orange */
.btn:hover {
  background-color: orange;
}

/* Smaller version of the .btn */
.btn-small {
  background-color: #e74c3c; /* same red */
  color: white;
  padding: 5px 8px;          /* smaller padding */
  border: none;
  border-radius: 5px;
  font-size: 0.75rem;        /* smaller font size */
  cursor: pointer;
  transition: background-color 0.3s;
}

.btn-small:hover {
  background-color: orange;  /* same hover effect */
}

/* Add set button */
.add-set-btn {
  background-color: #e74c3c; /* same red */
  color: white;
  padding: 10px 15px;          /* smaller padding */
  border: 5px;
  border-radius: 5px;
  font-size: 1rem;        /* smaller font size */
  cursor: pointer;
  transition: background-color 0.3s;
  margin: 5px 5px 5px 0;
}

.add-set-btn:hover {
  background-color: orange;  /* same hover effect */
}

/* Remove Exercise Button */
.remove-exercise-btn {
  background-color: #e74c3c; /* same red */
  color: white;
  padding: 10px 15px;          /* smaller padding */
  border: 5px;
  border-radius: 5px;
  font-size: 1rem;        /* smaller font size */
  cursor: pointer;
  transition: background-color 0.3s;
  margin: 5px 5px 5px 0;
}

.remove-exercise-btn:hover {
  background-color: orange;  /* same hover effect */
}

/* Remove Set Button */
.remove-set-btn {
  background-color: #e74c3c; /* same red */
  color: white;
  padding: 5px 8px;          /* smaller padding */
  border: none;
  border-radius: 5px;
  font-size: 0.75rem;        /* smaller font size */
  cursor: pointer;
  transition: background-color 0.3s;
}

.remove-set-btn:hover {
  background-color: orange;  /* same hover effect */
}

/* Layout Helpers */
.auth-buttons {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}

.button-container {
  display: flex;
  gap: 10px;
}

/* Input, Select, and Textarea Styles */
input[type="text"],
input[type="number"],
input[type="date"],
input[type="email"],
input[type="password"],
select,
textarea {
  width: 100%;
  max-width: 350px;
  padding: 10px;
  font-size: 1rem;
  box-sizing: border-box;
  margin-bottom: 15px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background-color: white;
  color: black;
}

textarea {
  height: 100px;
}

/* Password Eye Icon Styles */
.password-container {
  position: relative;
  width: 100%;
  max-width: 350px;
  margin-bottom: 15px;
}

.password-container input {
  padding-right: 35px;
}

.eye-icon {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  color: black;
  font-size: 20px;
}

/* Modal Overlay */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  background-color: rgba(0, 0, 0, 0.7); /* dark semi-transparent background */
  padding: 40px 10px; /* added horizontal padding for small screens */
}

/* Modal Content Box */
.modal-content {
  background-color: black;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
  width: 100%;
  max-width: 600px;
  max-height: 90%;
  overflow-y: auto;
  box-sizing: border-box;
}

/* Close Button */
.modal .close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.modal .close:hover,
.modal .close:focus {
  color: orange;
  text-decoration: none;
  cursor: pointer;
}

/* Mobile Optimizations */
@media (max-width: 480px) {
  .modal-content {
    padding: 16px;
    border-radius: 8px;
    margin: 20px auto;
  }

  .modal {
    padding: 20px 5px;
  }
}
/* Table Styles */
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

th {
  background-color: grey;
  color: white;
}

input[type="number"] {
  width: 70px;
  padding: 5px;
  font-size: 0.9rem;
}

.set-weight-dropdown {
  width: 80px;
  padding: 5px;
  font-size: 0.9rem;
}

/* Exercise Row Buttons */
#add-exercise-row-btn,
#save-workout-btn,
#edit-workout-btn,
#delete-workout-btn {
  background-color: #e74c3c;
}

#add-exercise-row-btn:hover,
#save-workout-btn:hover,
#edit-workout-btn:hover,
#delete-workout-btn:hover {
  background-color: orange; /* Hover color is orange */
}

/* Modal Label Styles */
.modal label {
  display: inline-block;
  margin-right: 10px;
  font-weight: bold;
}

.modal input[type="text"], .modal input[type="date"] {
  padding: 8px;
  font-size: 1rem;
  margin-bottom: 15px;
}

.exercise-row td:first-child input[type="text"] {
  font-size: 0.75rem;
  width: 100%;
  padding: 4px;
  max-width: 130px;
  box-sizing: border-box;
}

.exercise-row td:first-child {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.exercise-row td:first-child input[type="text"] {
  margin-top: 5px;
  width: 100%;
  font-size: 0.8rem;
  padding: 6px;
  text-align: center;
}

/* Modal Header Styles */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header .btn-container {
  display: flex;
  gap: 10px;
}

/* Horizontal Scroll Styles */
.horizontal-scroll {
  overflow-x: auto;
  width: 100%;
  margin-bottom: 20px;
}

.horizontal-scroll table {
  min-width: 1000px;
}

/* Target the specific header column by nth-child */
thead tr:first-child th:nth-child(2) {
  white-space: normal;  /* Allow wrapping */
  width: 100px;         /* Optional: set a max width */
  padding: 8px;         /* Add some padding for readability */
  word-wrap: break-word; /* Ensure long words break */
}

/* Modal Question Styles */
.modal .question {
  margin-bottom: 20px;
}

.modal .question input {
  padding: 8px;
  margin-top: 10px;
}

.modal .question select {
  padding: 8px;
  margin-top: 10px;
}

.modal .question textarea {
  padding: 8px;
  margin-top: 10px;
  width: 100%;
  height: 100px;
}

.modal label {
  display: block;
  text-align: left;
  margin-bottom: 5px;
  font-weight: bold;
}

/* Button Row Styles */
.button-row {
  display: flex;
  justify-content: space-between;
  margin-top: 1rem;
}

#download-btn {
  margin-right: auto;
}

#add-workout-btn {
  margin-left: auto;
}

/* Recent Workouts Styling */
#recent-workouts-list {
  list-style-type: none;   /* Remove bullet points */
  padding: 0;              /* Remove default padding */
  text-align: left;        /* Left align text */

  max-height: 300px;       /* Set max height for scroll */
  overflow-y: auto;        /* Enable vertical scrolling */
  padding-right: 10px;     /* Prevent content from getting cut off by scrollbar */
  margin: 0;
}

#recent-workouts-list li {
  margin: 5px 0;
}
</style>
  </head>
  <body>
<div class="auth-buttons">
  <div class="button-container">
    <button class="btn signup-btn">Sign Up</button>
    <button class="btn login-btn">Log In</button>
    <button class="btn logout" onclick="logout()">Log Out</button>
  </div>
  <div id="welcome-message" class="welcome-text"></div>
</div>


<!-- Login Modal -->
<div id="login-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-login-modal">&times;</span>

    <h2>Log In</h2>
    <form id="login-form">
      <!-- Username Input -->
      <label for="login-username">Username or Email:</label><br />
      <input type="text" id="login-username" required /><br /><br />
      
      <!-- Password Input -->
      <label for="login-password">Password:</label><br />
      <div class="password-container">
        <input type="password" id="login-password" required placeholder="Enter your password" />
        <span id="toggle-login-password" class="eye-icon">&#128065;</span>
      </div>


      <!-- Forgot Password + Cookie Policy Links -->
      <p style="margin-top: 5px; text-align: right;">
        <a href="#" id="forgot-password-link" style="color: orange; margin-right: 10px;">Forgot Password?</a>
        <a href="#" id="show-cookie-policy" style="color: blue;">Cookie Policy</a>
      </p>

      <!-- Submit Button -->
      <button type="submit" class="btn">Log In</button>
    </form>
  </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgot-password-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-forgot-password-modal">&times;</span>
    <h2>Forgot Password</h2>
    <p>Enter your email or username, and we'll send you a password reset link.</p>
    <input type="text" id="forgot-identifier" placeholder="Email or Username" required />
    <button id="submit-forgot-password" class="btn">Send Reset Link</button>
  </div>
</div>

<!-- Signup Modal -->

<div id="signup-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-signup-modal">&times;</span>
    <h2>Sign Up</h2>
    <form id="signup-form">
      <!-- Username Input -->
      <label for="signup-username">Username:</label><br />
      <input type="text" id="signup-username" required placeholder="Enter your username" /><br /><br />
      <!-- Email Input -->
      <label for="signup-email">Email:</label><br />
      <input type="email" id="signup-email" required placeholder="Enter your email" /><br /><br />
      <!-- Password Input -->
      <label for="signup-password">Password:</label><br />
      <div class="password-container">
        <input type="password" id="signup-password" required placeholder="Enter your password" />
        <span id="toggle-signup-password" class="eye-icon">&#128065;</span>
      </div><br />
      <!-- Confirm Password Input -->
      <label for="signup-confirm-password">Confirm Password:</label><br />
      <div class="password-container">
        <input type="password" id="signup-confirm-password" required placeholder="Confirm your password" />
        <span id="toggle-confirm-password" class="eye-icon">&#128065;</span>
      </div><br />
      <!-- Marketing Consent Checkbox -->
      <div class="checkbox-container">
        <input type="checkbox" id="marketing-consent" name="marketing-consent" />
        <label for="marketing-consent" style="display: inline;">
          I agree to receive promotional emails from Rep Dog. You can unsubscribe at any time. See our
         <a href="#" id="show-privacy-policy" style="color: blue;">Privacy Policy</a>
        </label>
      </div><br />
      <!-- Submit Button -->
      <button type="submit" class="btn">Sign Up</button>
    </form>
  </div>
</div>
 
<!-- Cookie Policy Modal -->
<div id="cookie-policy-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-cookie-policy-modal">&times;</span>
    <h2>Cookie Policy</h2>
    <p style="white-space: pre-wrap;">
Effective Date: 22/05/2025
RepDog does not currently use cookies to track you, serve ads, or analyse your behaviour.
We may use essential session-based technologies to help the app function (such as remembering your login session). These do not store data permanently and are not used for tracking or profiling.
We may update this policy if we introduce analytics, advertising, or other features that use cookies.
If you have any questions, contact us at privacy@repdog.fit
    </p>
  </div>
</div>

<!-- Privacy Policy Modal -->
<div id="privacy-policy-modal" class="modal">
  <div class="modal-content">
    <span class="close" id="close-privacy-policy-modal">&times;</span>
    <h2>Privacy Policy</h2>
    <p style="white-space: pre-wrap; max-height: 60vh; overflow-y: auto;">
Effective Date: 22/05/2025

1. Who We Are
RepDog is a web-based fitness and exercise tracking app available at www.repdog.fit...

2. What Information We Collect

We collect and process the following types of data:

Account Information: name, email address, password (hashed)
Workout Data: exercises, sets, reps, weights, and progress logs
Technical Data: IP address, browser type, operating system
Usage Data: pages visited, time spent on site
Cookies: see section 6 below

3. How We Use Your Information
We use your data to:

Provide and maintain your user account
Enable exercise tracking and progress features
Send transactional emails (e.g. password resets, confirmations)
Improve app performance and usability
Respond to support requests
We do not sell your personal data to third parties.

4. Legal Basis for Processing
We rely on the following legal bases:

Consent â€“ for cookies and marketing communications
Contract â€“ to provide the core tracking service
Legitimate Interest â€“ for basic analytics and security
Legal Obligation â€“ if required to comply with legal processes

5. Data Retention
We retain your data as long as you maintain an account. If you delete your account, we will delete your data within 30 days.

6. Cookies and Tracking
We use cookies to:

Remember your login session
Understand how users interact with the app (basic analytics)
You can control cookies via your browser settings. By continuing to use the site, you consent to our use of cookies.

7. Your Rights
You have the right to:

Access or download your personal data
Request correction or deletion
Object to processing or withdraw consent
File a complaint with a data protection authority (e.g. ICO if in the UK)
To exercise your rights, email: privacy@repdog.fit

8. Third-Party Services
We use trusted services to operate the app, such as:

Email delivery (e.g. Brevo)
Web hosting and database services
We ensure they meet strong security and privacy standards.

9. Data Security
We take appropriate technical and organizational measures to protect your data, including encryption, access controls, and secure hosting environments.

10. Changes to This Policy
We may update this Privacy Policy occasionally. If so, weâ€™ll notify you via the app or email.

11. Contact Us
If you have questions about this policy or your data, contact:
RepDog
Email: privacy@repdog.fit
    </p>
  </div>
</div>

  <div class="container">
    <div class="header">
	<img src="../images/RepDog.png" alt="RepDog Logo" width="300" height="200" />

      <p>Track your workouts and fitness journey</p>
<button class="btn" id="add-workout-btn">Create Workout</button>
    </div>
 
  <div class="dashboard-section">
  <div class="card">
    <h2>Recent Workouts</h2>

    <!-- ðŸ‘‡ Search input inserted here -->
    <input
      type="text"
      id="workout-search"
      placeholder="Search by workout name or date..."
      style="width: 100%; margin-bottom: 10px; padding: 8px; font-size: 16px;"
    >

    <p>Tap a workout to view or edit.</p>
    <p id="no-workouts" class="empty-message">No workouts added yet.</p>
    <ul id="recent-workouts-list" style="display: none;"></ul>
  </div>
</div>

   
  </div>
</div>
  </div>
 
<div id="workout-details-modal" class="modal">
  <div class="modal-content">
    <div id="workout-details-body"><!-- Injected content goes here --></div>
    <div class="button-row">
      <button id="edit-workout-btn" class="btn">Edit Workout</button>
      <button id="delete-workout-btn" class="btn">Delete Workout</button>
    </div>
  </div>
</div>
 
  <!-- Workout Modal -->
  <div id="create-workout-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="close-workout-modal">&times;</span>
 
      <div class="modal-header">
        <div>
          <label for="workout-name">Workout:</label>
          <input type="text" id="workout-name" placeholder="e.g. Upper Body" />
        </div>
        
      </div>
 
      <label for="workout-date">Date:</label>
      <input type="date" id="workout-date" />
 
     <!-- Horizontal scroll container for the table -->
  <div class="horizontal-scroll">
  <div id="exercise-rows"></div>
<button type="button" id="add-exercise-btn" class="btn">Add Exercise</button>
<button type="button" id="reset-form-btn" class="btn">Reset Form</button>

</div>
 
  <div class="button-container">
    <button id="save-workout-btn" class="btn">Save Workout</button>

</div>


      <!-- New questions under the workout table -->
      <div class="question">
        <label>Progress since last session? (Yes/No)</label>
        <select>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>

 
    
      <div class="question">
        <label>How do you feel the workout went? (1-10)</label>
        <input type="number" min="1" max="10" />
      </div>
 
      <div class="question">
        <label>Additional workout notes</label>
        <textarea placeholder="Write any notes..." rows="4"></textarea>
      </div>
 
      <div class="question">
        <label>Cardio:</label>
        <textarea placeholder="Describe your cardio workout..." rows="4"></textarea>
      </div>
 
      <!-- Buttons for editing and deleting workouts -->
      <button id="edit-workout-btn" style="display:none;">Edit Workout</button>
      <button id="delete-workout-btn" style="display:none;">Delete Workout</button>
    </div>
  </div>
 
  <script>
  document.addEventListener("DOMContentLoaded", () => {

const username = localStorage.getItem("username");
  if (username) {
    updateWelcomeMessage();  // Update the welcome message with username
  } else {
    updateWelcomeMessage();  // Show "Welcome!"
  }

//sets welcome message fuction

    function updateWelcomeMessage() {
  const welcomeMessage = document.getElementById("welcome-message");
  const username = localStorage.getItem("username");
  welcomeMessage.textContent = username ? `Logged in as: ${username}` : "Welcome!";
}
    const modal = document.getElementById("create-workout-modal");
    const addWorkoutBtn = document.getElementById("add-workout-btn");
    const closeModal = document.getElementById("close-workout-modal");
    const addExerciseRowBtn = document.getElementById("add-exercise-row-btn");
    const exerciseRowsContainer = document.getElementById("exercise-rows");
 
    const recentWorkoutsList = document.getElementById("recent-workouts-list");
    const noWorkoutsMessage = document.getElementById("no-workouts");

// Auth modal logic
const loginModal = document.getElementById("login-modal");
const signupModal = document.getElementById("signup-modal");
const loginBtn = document.querySelector(".login-btn");
const signupBtn = document.querySelector(".signup-btn");
const closeLogin = document.getElementById("close-login-modal");
const closeSignup = document.getElementById("close-signup-modal");
const forgotPasswordLink = document.getElementById("forgot-password-link");
const forgotPasswordModal = document.getElementById("forgot-password-modal");
const closeForgotPasswordModal = document.getElementById("close-forgot-password-modal");
const submitForgotPassword = document.getElementById("submit-forgot-password");
const logoutBtn = document.querySelector(".logout");

// Cookie Policy
  document.getElementById('show-cookie-policy').onclick = function () {
    document.getElementById('cookie-policy-modal').style.display = 'block';
  };
  document.getElementById('close-cookie-policy-modal').onclick = function () {
    document.getElementById('cookie-policy-modal').style.display = 'none';
  };

  // Privacy Policy
  document.getElementById('show-privacy-policy').onclick = function () {
    document.getElementById('privacy-policy-modal').style.display = 'block';
  };
  document.getElementById('close-privacy-policy-modal').onclick = function () {
    document.getElementById('privacy-policy-modal').style.display = 'none';
  };

  // Close modals when clicking outside
  window.onclick = function (event) {
    ['cookie-policy-modal', 'privacy-policy-modal'].forEach(id => {
      const modal = document.getElementById(id);
      if (event.target === modal) modal.style.display = 'none';
    });
  };

// Check login state from localStorage

function updateNavbar() {
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

  if (isLoggedIn) {
    loginBtn.style.display = "none";
    signupBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    loginBtn.style.display = "inline-block";
    signupBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
}

updateNavbar();

logoutBtn.addEventListener("click", (e) => {
  e.preventDefault();

  // Clear user data
  localStorage.removeItem("username");
  localStorage.setItem("isLoggedIn", "false");

  // Update UI
  updateWelcomeMessage(); // Reset welcome message
  updateNavbar(); // Update button visibility

  // Clear workout data
  recentWorkoutsList.innerHTML = "";
  noWorkoutsMessage.style.display = "block";
  recentWorkoutsList.style.display = "none";

  // Notify user
  alert("Logged out");
});

// Open modals
loginBtn.addEventListener("click", () => {
  loginModal.style.display = "block";
  document.body.style.overflow = "hidden";
});

signupBtn.addEventListener("click", () => {
  signupModal.style.display = "block";
  document.body.style.overflow = "hidden";
});

// Close modals
closeLogin.addEventListener("click", () => {
  loginModal.style.display = "none";
  document.body.style.overflow = "";
});

closeSignup.addEventListener("click", () => {
  signupModal.style.display = "none";
  document.body.style.overflow = "";
});

// Optional: Close modals by clicking outside content
window.addEventListener("click", (e) => {
  if (e.target === loginModal) {
    loginModal.style.display = "none";
    document.body.style.overflow = "";
  }
  if (e.target === signupModal) {
    signupModal.style.display = "none";
    document.body.style.overflow = "";
  }
});

// Eye icon toggle password visibility for both password fields in signup modal
const toggleSignupPassword = document.getElementById("toggle-signup-password");
const passwordInput = document.getElementById("signup-password");
const confirmPasswordInput = document.getElementById("signup-confirm-password");

toggleSignupPassword.addEventListener("click", () => {
  // Toggle visibility for both password and confirm password fields
  const type = passwordInput.type === "password" ? "text" : "password";
  passwordInput.type = type;
  confirmPasswordInput.type = type; // Make confirm password field also toggle
});

// Signup form submission
const signupForm = document.getElementById("signup-form");

signupForm.addEventListener("submit", async (event) => {
  event.preventDefault();

  const username = document.getElementById("signup-username").value;
  const email = document.getElementById("signup-email").value;
  const password = document.getElementById("signup-password").value;
  const confirmPassword = document.getElementById("signup-confirm-password").value;
  const marketingConsent = document.getElementById("marketing-consent").checked; // âœ… get checkbox value

  if (password !== confirmPassword) {
    alert("Passwords do not match!");
    return;
  }

  try {
    const response = await fetch('/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username,
        email,
        password,
        marketingConsent, // âœ… include checkbox in request
      }),
    });

    const data = await response.json();

    if (response.ok) {
      localStorage.setItem("username", username);
      localStorage.setItem("isLoggedIn", "true");
      updateWelcomeMessage();
      updateNavbar();

      alert('User registered successfully!');
      signupModal.style.display = "none";
      document.body.style.overflow = "";
    } else {
      alert(data.message || 'Error registering user');
    }
  } catch (error) {
    console.error('Error registering user:', error);
    alert('There was an error. Please try again.');
  }
});

// Toggle login password visibility
const toggleLoginPassword = document.getElementById("toggle-login-password");
const loginPasswordInput = document.getElementById("login-password");

toggleLoginPassword.addEventListener("click", () => {
  loginPasswordInput.type = loginPasswordInput.type === "password" ? "text" : "password";
});

// Login form submission
const loginForm = document.getElementById("login-form");

loginForm.addEventListener("submit", async (event) => {
  event.preventDefault();

  const usernameOrEmail = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;

  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usernameOrEmail, password }),
    });

    const data = await response.json();

    if (response.ok) {
      localStorage.setItem("username", data.username);
      localStorage.setItem("isLoggedIn", "true");
      updateWelcomeMessage();
      updateNavbar();

      loginModal.style.display = "none";
      document.body.style.overflow = "";
      loadRecentWorkouts();

      alert('Login successful!');
    } else {
      alert(data.message || 'Invalid credentials');
    }
  } catch (error) {
    console.error('Error logging in user:', error);
    alert('There was an error. Please try again.');
  }
});

// Show Forgot Password modal
forgotPasswordLink.addEventListener("click", () => {
  loginModal.style.display = "none"; // hide login modal
  forgotPasswordModal.style.display = "block";
  document.body.style.overflow = "hidden";
});

// Close modal
closeForgotPasswordModal.addEventListener("click", () => {
  forgotPasswordModal.style.display = "none";
  document.body.style.overflow = "";
});

// Handle submit
submitForgotPassword.addEventListener("click", async () => {
  const usernameOrEmail = document.getElementById("forgot-identifier").value.trim();

  if (!usernameOrEmail) {
    alert("Please enter your username or email.");
    return;
  }

  try {
    const response = await fetch("/forgot-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ usernameOrEmail }),
    });

    const resultText = await response.text();
    alert(resultText);
    forgotPasswordModal.style.display = "none";
    document.body.style.overflow = "";
  } catch (err) {
    console.error("Forgot password error:", err);
    alert("There was an error. Please try again.");
  }
});
 
// Fetch and display recent workouts
function loadRecentWorkouts() {
  const username = localStorage.getItem("username"); // fresh value
  if (!username) return;

  fetch(`/get-workouts?username=${encodeURIComponent(username)}`)
    .then(res => res.json())
    .then(workouts => {
      const normalizedWorkouts = workouts.map(w => ({
        ...w,
        id: w._id
      }));

      recentWorkoutsList.innerHTML = "";

      if (normalizedWorkouts.length === 0) {
        noWorkoutsMessage.style.display = "block";
        recentWorkoutsList.style.display = "none";
      } else {
        noWorkoutsMessage.style.display = "none";
        recentWorkoutsList.style.display = "block";
       
        // Sort workouts by date descending
       workouts.sort((a, b) => new Date(b.date) - new Date(a.date));

    workouts.forEach(w => {
  const li = document.createElement("li");  // <--- Create new li here

  // Convert date string to UK format
  const date = new Date(w.date);
  const ukFormattedDate = new Intl.DateTimeFormat('en-GB', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
  }).format(date);

  li.textContent = `${ukFormattedDate} :  ${w.workout}`;
  li.dataset.workoutId = w.id; // Add workout ID to the list item
  li.addEventListener("click", () => showWorkoutDetails(w)); // Add click event
  recentWorkoutsList.appendChild(li);
});
      }
    })
    .catch(err => {
      console.error("Failed to load workouts:", err);
    });
}

// Search filter logic 
workoutSearch.addEventListener("input", () => {
  const query = workoutSearch.value.toLowerCase();
  const filtered = allRecentWorkouts.filter(w =>
    w.workout.toLowerCase().includes(query) ||
    w.formattedDate.toLowerCase().includes(query)
  );

  renderWorkouts(filtered);
});

loadRecentWorkouts();
 
   function showWorkoutDetails(workout) {

// Convert date string to UK format
          const date = new Date(workout.date);
          const ukFormattedDate = new Intl.DateTimeFormat('en-GB', {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
          }).format(date);


  const workoutDetailsModal = document.getElementById("workout-details-modal");
  const workoutDetailsContent = document.getElementById("workout-details-content");

  // Build the modal content, starting with the close button
  const workoutDetails = `
    <span class="close" id="close-workout-details-modal">&times;</span>
    <h2> ${ukFormattedDate}: ${workout.workout}</h2>
    <h3>Exercises:</h3>
    <ul>
      ${workout.exercises.map(exercise => `
        <li>
          <strong>${exercise.name}</strong>
          <p> Progress Next Workout: ${exercise.progressNextWorkout ? 'Yes' : 'No'}</p>
          <ul>
            ${exercise.sets.map(set => `
              <li>Weight: ${set.weight} ${exercise.weightUnit} | Reps: ${set.reps}</li>
            `).join("")}
          </ul>
        </li>
      `).join("")}
    </ul>
    <p>Progress Your Lifts: ${workout.progressYourLifts}</p>
    <p>Rating: ${workout.workoutRating}</p>
    <h3>Notes:</h3>
    <p>${workout.additionalNotes}</p>
    <h3>Cardio:</h3>
    <p>${workout.cardio}</p>
  `;

  // Inject content
  document.getElementById("workout-details-body").innerHTML = workoutDetails;

// Attach the Edit button click event
document.getElementById("edit-workout-btn").addEventListener("click", () => {
    openEditWorkoutModal(workout); // Open the form with pre-filled data
    workoutDetailsModal.style.display = "none"; // Close the details modal
});

  // Reattach close functionality since we injected new HTML
  document.getElementById("close-workout-details-modal").addEventListener("click", () => {
    workoutDetailsModal.style.display = "none";
    document.body.style.overflow = "";
  });


function openEditWorkoutModal(workout) {
    // Open the modal
    modal.style.display = "block";
    document.body.style.overflow = "hidden";

console.log("Editing workout object:", workout);
console.log("Workout ID:", workout.id);

    // Set the editing workout ID
    modal.dataset.editingWorkoutId = workout.id || workout._id;

    // Populate basic workout info
    document.getElementById("workout-name").value = workout.workout;
    document.getElementById("workout-date").value = new Date(workout.date).toISOString().slice(0, 10);
    document.querySelectorAll(".question select")[0].value = workout.progressYourLifts;
    document.querySelectorAll(".question input[type='number']")[0].value = workout.workoutRating || "";
    document.querySelectorAll(".question textarea")[0].value = workout.additionalNotes || "";
    document.querySelectorAll(".question textarea")[1].value = workout.cardio || "";

    // Clear current exercise rows
    exerciseRowsContainer.innerHTML = "";

    // Populate exercises dynamically
    workout.exercises.forEach((exercise, index) => {
        const exerciseBlock = createExerciseBlock(index, true);
        exerciseBlock.querySelector(".exercise-name").value = exercise.name;
        exerciseBlock.querySelector(".unit-select").value = exercise.weightUnit;
        exerciseBlock.querySelector(".progress-checkbox").checked = exercise.progressNextWorkout;

        const setsContainer = exerciseBlock.querySelector(".sets-container");
        exercise.sets.forEach(set => {
            const setDiv = document.createElement("div");
            setDiv.className = "set";
            setDiv.innerHTML = `
                <input type="number" placeholder="Weight" class="weight" value="${set.weight}" />
                <input type="number" placeholder="Reps" class="reps" value="${set.reps}" />
                <button class="remove-set-btn">Remove Set</button>
            `;
            setsContainer.appendChild(setDiv);

            setDiv.querySelector(".remove-set-btn").addEventListener("click", () => {
                setDiv.remove();
            });
        });

        exerciseRowsContainer.appendChild(exerciseBlock);
    });
}

  // Show the modal
  workoutDetailsModal.style.display = "block";
  document.body.style.overflow = "hidden";
}
 

// Save workout
document.getElementById("save-workout-btn").addEventListener("click", () => {
    const workoutId = modal.dataset.editingWorkoutId || null;
    console.log("Saving workout ID:", workoutId);
    const username = localStorage.getItem("username");
    const workout = document.getElementById("workout-name").value.trim();
    const date = document.getElementById("workout-date").value;
    const progressYourLifts = document.querySelectorAll(".question select")[0].value;
    const workoutRating = parseInt(document.querySelectorAll(".question input[type='number']")[0].value) || null;
    const additionalNotes = document.querySelectorAll(".question textarea")[0].value;
    const cardio = document.querySelectorAll(".question textarea")[1].value;

    const exerciseRows = Array.from(document.querySelectorAll(".exercise-row"));
    const exercises = exerciseRows.map(row => {
        const name = row.querySelector(".exercise-name").value.trim();
        const weightUnit = row.querySelector(".unit-select").value;
        const progressNextWorkout = row.querySelector(".progress-checkbox").checked;

        const sets = Array.from(row.querySelectorAll(".sets-container .set")).map(setDiv => {
            const weight = parseFloat(setDiv.querySelector(".weight").value);
            const reps = parseInt(setDiv.querySelector(".reps").value);
            return { weight, reps };
        }).filter(set => !isNaN(set.weight) && !isNaN(set.reps));

        return { name, weightUnit, progressNextWorkout, sets };
    }).filter(ex => ex.sets.length > 0 && ex.name);

    if (!username || !workout || !date || exercises.length === 0) {
        alert("Please fill in all required fields.");
        return;
    }

    const workoutData = {
        username,
        workout,
        date,
        exercises,
        progressYourLifts,
        workoutRating,
        additionalNotes,
        cardio,
    };

    const endpoint = workoutId ? `/update-workout/${workoutId}` : "/add-workout";
    const method = workoutId ? "PUT" : "POST";

    fetch(endpoint, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(workoutData)
    })
    .then(res => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
    })
    .then(data => {
        alert("Workout saved successfully!");
        modal.style.display = "none";
        document.body.style.overflow = "";
        resetWorkoutForm();
        loadRecentWorkouts();
    })
    .catch(err => {
        console.error("Failed to save workout:", err);
        alert("Error saving workout. Check console for details.");
    });
});

 
 function resetWorkoutForm() {
  // Clear basic input fields
  document.getElementById("workout-name").value = "";
  document.getElementById("workout-date").value = "";
  document.querySelectorAll(".question select").forEach(select => select.value = "");
  document.querySelectorAll(".question input[type='number']").forEach(input => input.value = "");
  document.querySelectorAll(".question textarea").forEach(textarea => textarea.value = "");
  
  // âœ… Reset all checkboxes to unchecked
  document.querySelectorAll(".question input[type='checkbox']").forEach(checkbox => checkbox.checked = false);

  // Clear the exercise rows container
  const exerciseRowsContainer = document.getElementById("exercise-rows");
  exerciseRowsContainer.innerHTML = "";

   // âœ… Add a new blank exercise row using your existing function
  exerciseRowsContainer.appendChild(createExerciseBlock(0));
}


 addWorkoutBtn.addEventListener("click", () => {
    // Clear any previous workout data from the form
    resetWorkoutForm();

    // Make sure we are not in edit mode
    modal.removeAttribute("data-editingWorkoutId");

    // Show the modal
    modal.style.display = "block";
    document.body.style.overflow = "hidden";
});


    closeModal.addEventListener("click", () => {
      modal.style.display = "none";
      document.body.style.overflow = "";
    });
 
    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
        document.body.style.overflow = "";
      }
    });
 
    // Auto-load recent workouts on page load
    loadRecentWorkouts();
  });

const exerciseRowsContainer = document.getElementById("exercise-rows");
const addExerciseBtn = document.getElementById("add-exercise-btn");
const resetFormBtn = document.getElementById("reset-form-btn");

function createExerciseBlock(index, skipDefaultSet = false) {
  const div = document.createElement("div");
  div.className = "exercise-row";
  div.setAttribute("data-index", index);
  div.innerHTML = `
    <input type="text" placeholder="Exercise name" class="exercise-name" />
    <label>
      <input type="checkbox" class="progress-checkbox" /> Plan to progress next session
    </label>
    <select class="unit-select">
      <option value="kg">kg</option>
      <option value="lbs">lbs</option>
    </select>
    <div class="sets-container">
      <!-- Removed default set here to avoid extra set on edit -->
    </div>
    <button class="add-set-btn">Add Set</button>
    <button class="remove-exercise-btn">Remove Exercise</button>
  `;

  const setsContainer = div.querySelector(".sets-container");

  // Add default set ONLY if skipDefaultSet is false (new)
  if (!skipDefaultSet) {
    const defaultSet = document.createElement("div");
    defaultSet.className = "set";
    defaultSet.innerHTML = `
      <input type="number" placeholder="Weight" class="weight" />
      <input type="number" placeholder="Reps" class="reps" />
    `;
    setsContainer.appendChild(defaultSet);
  }

  div.querySelector(".add-set-btn").addEventListener("click", () => {
    const newSet = document.createElement("div");
    newSet.className = "set";
    newSet.innerHTML = `
      <input type="number" placeholder="Weight" class="weight" />
      <input type="number" placeholder="Reps" class="reps" />
      <button class="remove-set-btn">Remove Set</button>
    `;
    setsContainer.appendChild(newSet);

    newSet.querySelector(".remove-set-btn").addEventListener("click", () => {
      newSet.remove();
    });
  });

  div.querySelector(".remove-exercise-btn").addEventListener("click", () => {
    div.remove();
  });

  return div;
}


addExerciseBtn.addEventListener("click", () => {
  const index = exerciseRowsContainer.children.length;
  exerciseRowsContainer.appendChild(createExerciseBlock(index));
});

resetFormBtn.addEventListener("click", () => {
  exerciseRowsContainer.innerHTML = "";
  exerciseRowsContainer.appendChild(createExerciseBlock(0));
});

// Initialize form with one exercise
resetFormBtn.click();




  </script>
 
  </body>
  </html>